<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaction Data</title>
  <link rel="stylesheet" href="style.css">

  <!-- PyScript -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>

  <!-- Configure Python environment -->
  <py-config>
    packages = ["pandas"]
  </py-config>
</head>
<body>
  <header>
    <h1>Transaction Data</h1>
    <p>Forex, Cryptocurrency, and Tehran Stock Market Trading</p>
  </header>

  <section>
    <h2>Run Python Code</h2>
    <p>The following analysis is executed directly in your browser using PyScript:</p>

    <!-- Output box -->
    <pre id="output"></pre>

    <py-script>
import pandas as pd

# -----------------------------
# Functions
# -----------------------------
def load_and_preprocess(file_name, is_price_data=False):
    try:
        df = pd.read_csv(file_name)
        if is_price_data:
            df['GBP-IRR ratio'] = df['GBP-IRR ratio'].str.replace(',', '').astype(float)
        df = df.sort_values(by='date(shamsi)')
        df.reset_index(drop=True, inplace=True)
        return df
    except Exception as e:
        print(f"Error loading {file_name}: {e}")
        return None

def sync_gbp_irr_ratio(price_df, dataset):
    try:
        dataset = dataset.copy()
        dataset['GBP-IRR ratio'] = dataset['date(shamsi)'].map(
            lambda d: price_df.loc[price_df['date(shamsi)'] == d, 'GBP-IRR ratio'].iloc[0]
            if d in price_df['date(shamsi)'].values else None
        )
        return dataset.dropna(subset=['GBP-IRR ratio'])
    except Exception as e:
        print(f"Error syncing GBP-IRR ratio: {e}")
        return dataset

def calculate_trade_value(dataset):
    try:
        dataset = dataset.copy()
        dataset.loc[:, 'sum_day'] = (
            (dataset['number of buy'] * dataset['avg price buy'] +
             dataset['number of sell'] * dataset['avg price sell']) / dataset['GBP-IRR ratio']
        )
        return dataset['sum_day'].sum()
    except Exception as e:
        print(f"Error calculating trade value: {e}")
        return 0

# -----------------------------
# Load data
# -----------------------------
price_data = load_and_preprocess("GBP-IRR.csv", is_price_data=True)

names = [
    "Amirali Nakhaei", "Amirhessam Nakhaei", "Ahmad Nakhaei",
    "Fatemeh Komlakh", "Mohammadreza Nakhaei"
]

trade_values = {}
if price_data is not None:
    for name in names:
        df = load_and_preprocess(f"{name}.csv")
        if df is not None:
            synced_df = sync_gbp_irr_ratio(price_data, df)
            trade_values[name] = calculate_trade_value(synced_df)

# -----------------------------
# Print results to output box
# -----------------------------
out = ""
for name, value in trade_values.items():
    out += f"{name}'s account trade value is: {int(value):,}£\n\n"

total_trade_value = sum(trade_values.values())
out += f"Total trade value is: {int(total_trade_value):,}£\n"

# Send to HTML
from js import document
document.getElementById("output").innerText = out
    </py-script>
  </section>

  <footer>
    <p><a href="index.html">⬅ Back to Main Page</a></p>
  </footer>
</body>
</html>
